# 概要

- このファイルは Minecraft ModPack Installer プロジェクトの設計書である。
- 本ツールは Minecraft 用 ModPack のダウンロード・適用・維持を自動化し、プレイヤーと ModPack 制作者双方の体験を向上させる。
- 主要利用者: ModPack プレイヤー (インストール/更新/修復) と ModPack 制作者 (設定ジェネレーター)。

## 目次

- [目的と範囲](#目的と範囲)
- [前提と用語](#前提と用語)
- [要件](#要件)
  - [機能要件](#機能要件)
  - [非機能要件](#非機能要件)
- [アーキテクチャ概要](#アーキテクチャ概要)
- [コア機能](#コア機能)
  - [ModPack インストーラー](#modpack-インストーラー)
  - [インストーラー設定ジェネレーター](#インストーラー設定ジェネレーター)
- [UX 指針](#ux-指針)
- [セキュリティ指針](#セキュリティ指針)
- [ファイルフォーマット](#ファイルフォーマット)
  - [config.yaml](#configyaml)
  - [installer-state.json](#installer-statejson)
- [ログと監視](#ログと監視)
- [今後の課題](#今後の課題)

## 目的と範囲

- プレイヤーが `config.yaml` を用いて ModPack をインストール・アップデート・修復できる環境を提供する。
- ModPack 制作者が GUI を通じて安全かつ視覚的に `config.yaml` を生成できるよう支援する。
- 対象プラットフォームは Windows を主とし、Tauri の特性を活かしたクロスプラットフォーム対応(macOS、Linux)を視野に入れる。

## 前提と用語

- `config.yaml`: ModPack の構成情報を表す設定ファイル。インストーラー起動ディレクトリに配置する。
- `installer-state.json`: インストールやアップデートの結果を記録する JSON ファイル (インストーラー状態ファイル)。次回実行時の差分計算に用いる。
- 一時ディレクトリ: ダウンロード完了前のファイルを格納する領域。モード開始時に再初期化し、中断時の不整合を防ぐ。
- CurseForge API キー: Mod 情報を取得するための機密キー。メモリ内のみで保持し、永続化しない。

## 要件

### 機能要件

- ModPack インストーラーは `config.yaml` を読み取り、適切なモードで必要ファイルのダウンロード・配置・削除を行う。
- インストール、アップデート、修復の 3 モードを提供し、それぞれ定義済みの前提条件と挙動を持つ。
- モード共通で、ファイルは一時ディレクトリに取得し、ハッシュ検証後に最終配置する。
- インストーラー設定ジェネレーターは `config.yaml` の読み込み・編集・検証・書き出しを GUI 上で行う。
- CurseForge API を用いた Mod メタデータ取得と補完を提供し、ダイレクト URL 指定との切り替えをサポートする。
  - CurseForge 版 Mod では Project ID と File ID を入力すると API 経由で正式 URL とファイル名を取得し、`config.yaml` の `url` を自動反映する。

### 非機能要件

- 中断耐性: 任意のタイミングでプロセスが強制終了しても、再開時に不整合なく処理を完了できる。
- UI 品質: WebView (React) により分かりやすく拡張性の高い UI を提供する。
- パフォーマンス: 重い処理は Rust バックエンドに集約し、並列/並行処理を活用して高速に実行する。
- 可観測性: 重要イベントを読みやすいテキストログとして記録し、トラブルシューティングを容易にする。
- 保守性: フロントエンドとバックエンドで責務分離し、設定スキーマの変更が追跡しやすい構造にする。

## アーキテクチャ概要

- フレームワーク: Tauri を採用し、WebView (React/TypeScript) と Rust バックエンドを組み合わせる。
- プロセス分離: フロントエンドはユーザー操作とフィードバックを担い、Rust 側は IO・並列処理・検証を担当する。
- IPC: Tauri のコマンド機構で UI とバックエンド間の通信を行い、進捗やエラーをリアルタイムに反映する。
- 依存関係: `pnpm` によるフロントエンド依存解決、Cargo によるバックエンド依存管理を行う。

| レイヤー         | 技術スタック              | 主責務                                   | 主な関心事                                   |
| ---------------- | ------------------------- | ---------------------------------------- | -------------------------------------------- |
| UI               | React / Vite / TypeScript | 操作フロー、進捗表示、設定編集           | UX、一貫したバリデーション、アクセシビリティ |
| アプリケーション | Tauri コマンド            | IPC、状態管理、中断再開                  | スレッドセーフな処理、エラー伝播             |
| バックエンド     | Rust                      | ダウンロード、ハッシュ検証、ファイル操作 | 並列処理、IO 最適化、例外ハンドリング        |

## コア機能

### ModPack インストーラー

- `config.yaml` を起動ディレクトリから読み込み、選択モードに応じてファイル群を同期する。
- モード開始時に一時ディレクトリを再初期化し、完了時に必要な成果物のみを本ディレクトリへ移動する。

#### 共通処理フロー

1. 前提確認: `config.yaml` の存在、整合性、バージョン互換性を検証する。
2. 一時ディレクトリ初期化: 既存の一時ディレクトリを削除し、空の状態で作成する。
3. 並列ダウンロード: ネットワーク負荷を考慮した並列度でファイルを取得する。
4. ハッシュ検証: 取得完了後に定義済みハッシュと照合し、失敗時はリトライまたはユーザーに通知する。
5. アトミック配置: 検証済みファイルを目的ディレクトリに移動する。
6. 状態更新: `installer-state.json` を必要に応じて更新・永続化する。

#### モード比較

| モード       | 主目的           | 主な操作フロー                                                                | ユーザー前提条件                                                                | 特記事項                                                     |
| ------------ | ---------------- | ----------------------------------------------------------------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| インストール | 初回導入         | Mod → リソース → ModLoader → プロファイル作成 → ModLoader 起動                | 実行ディレクトリに `config.yaml` とインストーラー本体以外のファイルが存在しない | 各ダウンロード完了ごとに `installer-state.json` へ状態を保存 |
| アップデート | 差分適用         | 既存 `installer-state.json` と `config.yaml` を比較し、追加は取得、削除は清掃 | 過去に生成された `installer-state.json` が存在する                              | `config.yaml` に無いユーザー独自ファイルは保持               |
| 修復         | 正常状態への復旧 | `config.yaml` と現状を突き合わせ、不要 Mod を削除し不足分を補完               | 既存環境を維持したまま再実行可                                                  | Mod は強制同期、リソースは追加のみで削除しない               |

#### インストールモード

1. 実行ディレクトリに余計なファイルが無いか検査する。
2. Mod をダウンロードし、ハッシュ検証後に所定ディレクトリへ配置する。
3. リソースファイルをダウンロードし、ハッシュ検証後に相対パスに基づいて配置する。
4. ModLoader をダウンロードし、ハッシュ検証後に設置する。
5. Minecraft Launcher プロファイルを作成し、必要な設定 (名前・アイコン・バージョン・JVM パラメータ) を登録する。
6. `installer-state.json` を生成し、各ダウンロード終了時に逐次保存する。
7. ModLoader を起動する。

#### アップデートモード

1. `installer-state.json` を読み込み、記録されているファイルが実際に存在するか検証し、欠落しているエントリを削除して保存する。
2. `installer-state.json` と `config.yaml` を比較し、ファイル差分を抽出する。
3. 追加または更新が必要な Mod／リソースをダウンロードし、ハッシュ検証後に置き換える。
4. 削除対象となるエントリをリスト化し、ユーザーが追加した未定義ファイルを誤って削除しないようフィルターする。
5. 変更差分を反映した `installer-state.json` を保存する。

#### 修復モード

1. `installer-state.json` を読み込み、実際のディレクトリに存在しないファイルのエントリを削除して保存する。
2. `config.yaml` と現行ディレクトリの差異を検出し、不足ファイルをダウンロードする。
3. 既存ファイルについて、実ファイルのハッシュが `installer-state.json` に記録された値と一致するか検証する。
   - Mod のハッシュが不一致の場合は、再ダウンロードして上書きする。
   - リソースのハッシュが不一致の場合は、ユーザーに確認を取り、承認後に再ダウンロードして上書きする。
4. Mod については `config.yaml` に無いファイルを削除し、リソースについては不足分のみ補完する。
5. 実行後に `installer-state.json` を更新し、最新状態を記録する。

#### エラー処理とリカバリ

- ダウンロード失敗時は指数バックオフ付きリトライを行い、最終的に失敗した場合はユーザーに選択肢 (再試行/中断) を提示する。
- ハッシュ不一致が継続する場合は、信頼できないソースとして警告を表示し、続行可否を明示的に確認する。

### インストーラー設定ジェネレーター

- ModPack 制作者向けの隠し機能として `config.yaml` の生成と編集をサポートする。
- 起動時に CurseForge API キーを一時的に取得し、メモリにのみ保持する。キーの再入力や破棄操作も UI で提供する。
- Mod エントリは CurseForge 版とダイレクト URL 版を切り替えるラジオボタンを持ち、選択に応じて必須入力項目を変化させる。
- CurseForge 版では Project ID 変更時に自動補完とアイコンプレビューを行い、File ID は最新順のドロップダウンで提示する。
- CurseForge 版で Required Dependencies が `config.yaml` の Mod リストに存在しない場合は、依存関係不足バッジを表示し、その場で追加できる「依存関係を追加」ボタンを提示する。
- 新しいバージョンが存在する場合は視覚的なバッジで通知し、更新操作を誘導する。
- 編集内容はローカル検証を通過した場合のみ保存できるよう、スキーマバリデーション結果を即時フィードバックする。

## UX 指針

- 各モードで進捗バーとステップ表示を用意し、現在の処理と残りタスクを明確にする。
- 重要な待機操作は非同期で行い、UI がブロックされないようローディングインジケーターを表示する。
- UI コンポーネントは Material Design を採用し、一貫した視覚言語と操作パターンを提供する。
- エラー時は原因・対象ファイル・推奨アクションを組み合わせて提示し、ログディレクトリを開くボタンを併記する。
- 設定ジェネレーターではフォーム入力のリアルタイム検証とアクセシブルなエラーメッセージを表示する。
- ダーク/ライトテーマに対応し、配色とコントラストは WCAG AA 以上を目標とする。
- UI 文言は国際化対応 (i18n) を前提に設計し、初版では日本語と英語を提供する。将来的な言語追加が容易になるよう、文言をリソースファイルで管理し、コンポーネントからはキー参照とフォーマット関数で利用する。

## セキュリティ指針

- すべてのダウンロードは HTTPS を必須とし、証明書ピンニングまたはドメインホワイトリストで中間者攻撃を防ぐ。
- ハッシュ検証は SHA-256 以上を使用し、不一致時は再取得またはユーザー確認なしに配置しない。
- CurseForge API キーはメモリ内のみで扱い、コピーやログ出力を禁止する。未使用時には確実に破棄する。
- ログには個人情報やシークレットを含めず、必要な場合はトークナイズやマスキングを行う。

## ファイルフォーマット

### config.yaml

- インストーラーが参照する主設定ファイル。以下の構造を前提とする。

```yaml
profile:
   name: string
   icon: string
   version: string
   jvmArgs: string | null
modLoader:
   name: string
   url: string
   hash: string
mods:
   - name: string
      type: curseforge | direct
      projectId: number? # type=curseforge の場合に必須
      fileId: number?
      url: string
      hash: string
resources:
   - name: string
      targetDir: string
      url: string
      hash: string
```

- バリデーション
  - profile: `name` と `version` は必須、`jvmArgs` は任意。
  - modLoader: `name`/`url`/`hash` の 3 つは必須。`url` は HTTPS を強制する。
  - mods: `url` プロパティは `type` に関わらず必須。CurseForge 版では `projectId`/`fileId` と整合する正式ダウンロード URL を保存し、GUI から API 呼び出しで補完する。重複 Project ID + File ID の登録を防ぐ。
  - resources: `targetDir` は `../` を含まない正規化済み相対パスに限定する。

### installer-state.json

- インストーラーの処理結果を JSON 形式で記録し、アップデートと修復で参照する。
- バージョン互換性のために `installerVersion` をルートプロパティとして保持し、フォーマット変更時はマイグレーションを行う。

```json
{
  "installerVersion": "string",
  "modLoader": {
    "fileName": "string",
    "url": "string",
    "hash": "string"
  },
  "mods": [
    {
      "fileName": "string",
      "projectId": 123,
      "fileId": 456,
      "url": "string",
      "hash": "string"
    }
  ],
  "resources": [
    {
      "fileName": "string",
      "targetDir": "string",
      "url": "string",
      "hash": "string"
    }
  ]
}
```

- 記録対象
  - ファイル名は実際に配置した成果物名を保持する。
  - URL は将来的な監査や再ダウンロード確認のために保存するが、直接利用はしない。
  - リソース `targetDir` は相対パスで保持し、実行時に絶対パスへ解決する。
  - JSON シリアライズ時に `null` を保持するフィールド (例: `projectId`, `fileId`, `url`) は `null` として明示し、省略しない。

## ログと監視

- バックエンドで人が読みやすいテキストログ (例: `[2025-11-04 10:15:03][INFO] Download start: mod=ExampleMod`) を出力し、ステップ・ファイル名・結果・所要時間を記録する。
- UI からログディレクトリを開くボタンを提供し、ユーザーが外部エディターでテキストログを確認しやすくする。
- クリティカルエラーは OS の通知 API を利用して即時に知らせる。

## 今後の課題

- 署名付きハッシュや複数ミラーからのダウンロードなど、信頼性向上機能の検討。
- ModPack 依存関係解決や互換性チェック機能の追加。
- 自動テレメトリ (任意参加) による品質改善と UX 指標の収集。
